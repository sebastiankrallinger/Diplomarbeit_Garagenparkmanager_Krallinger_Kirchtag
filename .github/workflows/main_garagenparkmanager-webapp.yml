name: Build and Deploy

on:
    push:
        branches:
            - main

env:
    DOTNET_VERSION: '8.0.x'

jobs:
    build:
        runs-on: windows-latest
        environment: Azure
  
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
    
          - name: Set up .NET
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: ${{ env.DOTNET_VERSION }}
    
          - name: Restore Dependencies
            run: dotnet restore Garagenparkmanager/Garagenparkmanager.sln
    
          - name: Build Server
            run: dotnet build -c Release --no-restore Garagenparkmanager/Garagenparkmanager.sln

          - name: Install frontend dependencies
            run: |
             cd Garagenparkmanager/garagenparkmanager.client
             npm install
          - name: Build frontend
            run: |
             cd Garagenparkmanager/garagenparkmanager.client
             npm run build

          - name: Publish Server
            run: dotnet publish -c Release -o ./out Garagenparkmanager/Garagenparkmanager.sln

          - name: Copy Frontend Assets
            run: |
             xcopy /s /y Garagenparkmanager/garagenparkmanager.client/dist ./out/wwwroot
    
          - name: Deploy to Azure Web Apps
            uses: azure/webapps-deploy@v2
            with:
              app-name: Garagenparkmanager-Webapp
              publish-profile: ${{ secrets.AZURE_WEBAPP_GARAGENPARKMANAGER }}
              package: ./out      
